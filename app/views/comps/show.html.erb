<% provide(:title, 'Team Stats') %>
<% arr = @comp.listplayers.split(',') %>
<% arr.pop %>
<% arr.sort_by! { |k, v| k.capitalize! } %>

<table class="table">
  <thead>
    <tr>
      <th width="10%">Toon</th>
      <th width="12%"></th>
      <th width="18%">RBG Stats</th>
      <th width="30%">Arena Stats</th>
      <th width="30%">Gems/Enchants</th>
    </tr>
  </thead>

  <tbody>
	<% arr.each do |x| %>
		<% character_name = x.split('-')[0] %>
		<% realm = x.split('-')[1] %>
		<% armory = HTTParty.get("http://us.battle.net/api/wow/character/" + realm + "/" + character_name + "?fields=stats,pvp,items,achievements,talents").to_h %>
		<% thumbnail = armory["thumbnail"] %>		
		<% ilvl = armory["items"]["averageItemLevelEquipped"] %>
		<% cr = armory["pvp"]["brackets"]["ARENA_BRACKET_RBG"]["rating"] %>
		<% rbgw = armory["pvp"]["brackets"]["ARENA_BRACKET_RBG"]["seasonWon"] %>
		<% rbgl = armory["pvp"]["brackets"]["ARENA_BRACKET_RBG"]["seasonLost"] %>
		<% winratio = (rbgw.to_f / (rbgw + rbgl) * 100).round(2) %>
		<% arena2 = armory["pvp"]["brackets"]["ARENA_BRACKET_2v2"]["rating"] %>
		<% arena2w = armory["pvp"]["brackets"]["ARENA_BRACKET_2v2"]["seasonWon"] %>
		<% arena2l = armory["pvp"]["brackets"]["ARENA_BRACKET_2v2"]["seasonLost"] %>
	    <% arena3 = armory["pvp"]["brackets"]["ARENA_BRACKET_3v3"]["rating"] %>
		<% arena3w = armory["pvp"]["brackets"]["ARENA_BRACKET_3v3"]["seasonWon"] %>
		<% arena3l = armory["pvp"]["brackets"]["ARENA_BRACKET_3v3"]["seasonLost"] %>
	    <% arena5 = armory["pvp"]["brackets"]["ARENA_BRACKED_5v5"]["rating"] %>
		<% arena5w = armory["pvp"]["brackets"]["ARENA_BRACKED_5v5"]["seasonWon"] %>
		<% arena5l = armory["pvp"]["brackets"]["ARENA_BRACKED_5v5"]["seasonLost"] %>
	    <% pvpresil = armory["stats"]["pvpResilienceRating"] %>
    	<% health = armory["stats"]["health"] %>
    	<% gender = armory["gender"] %>
    	<% race = armory["race"] %>
    	<% cls = armory["class"] %>
    	<% spec = "http://media.blizzard.com/wow/icons/36/" + armory["talents"][0]["spec"]["icon"] + ".jpg" %>

    	<% gems = {} %>
    	<% gems2 = {} %>
    	<% gems2["head"] = armory["items"]["head"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems["shoulder"] = armory["items"]["shoulder"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems2["chest"] = armory["items"]["chest"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems["hands"] = armory["items"]["hands"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems2["waist"] = armory["items"]["waist"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems2["legs"] = armory["items"]["legs"]["tooltipParams"].to_a.join(' ').scan("gem").count %>
    	<% gems["feet"] = armory["items"]["feet"]["tooltipParams"].to_a.join(' ').scan("gem").count %>

    	<% enchant = Hash.new(0) %>
    	<% enchant["shoulder"] = armory["items"]["shoulder"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["back"] = armory["items"]["back"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["chest"] = armory["items"]["chest"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["wrist"] = armory["items"]["wrist"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>			
    	<% enchant["waist"] = armory["items"]["waist"]["tooltipParams"].to_a.join(' ').scan("Socket").count %>
    	<% enchant["hands"] = armory["items"]["hands"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["legs"] = armory["items"]["legs"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["feet"] = armory["items"]["feet"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>
    	<% enchant["weapon"] = armory["items"]["mainHand"]["tooltipParams"].to_a.join(' ').scan("enchant").count %>

		<% achievements = armory["achievements"]["achievementsCompleted"] %>
	    <% achv2 = 0 %>
	    <% achv3 = 0 %>
	    <% achv5 = 0 %>
	    <% title = "Scrub" %>
	    <% arena_master = false %>
	    <% achv2 = 1550 if achievements.include? 399 %>
	    <% achv2 = 1750 if achievements.include? 400 %>
	    <% achv2 = 2000 if achievements.include? 401 %>
	    <% achv2 = 2200 if achievements.include? 1159 %>
	    <% achv3 = 1550 if achievements.include? 402 %>
	    <% achv3 = 1750 if achievements.include? 403 %>
	    <% achv3 = 2000 if achievements.include? 405 %>
	    <% achv3 = 2200 if achievements.include? 1160 %>
	    <% achv3 = 2400 if achievements.include? 5266 %>
	    <% achv3 = 2700 if achievements.include? 5267 %>
	    <% achv5 = 1550 if achievements.include? 406 %>
	    <% achv5 = 1750 if achievements.include? 407 %>
	    <% achv5 = 2000 if achievements.include? 404 %>
	    <% achv5 = 2200 if achievements.include? 1161 %>
	    <% title = "Challenger" if achievements.include? 2090 %>
	    <% title = "Rival" if achievements.include? 2093 %>
	    <% title = "Duelist" if achievements.include? 2092 %>
	    <% title = "Gladiator" if achievements.include? 2091 %>
	    <% arena_master = true if achievements.include? 1174 %>

		<tr>
		    <td><!-- Toon -->
		    	<h4><%= link_to character_name, "http://us.battle.net/wow/en/character/#{realm}/#{character_name}/advanced", :target => "_blank"  %></h4>
		    	<%= title %><br>
		    	<% if arena_master %>
		    		Arena Master<br>
		    	<% end %>
		    	<small><%= "#{[achv2, achv3, achv5].sort[-1]} Arena Exp" %></small><br>
		    	<strong><%= "#{ilvl} iLvl" %></strong>
			</td>

			<td><!-- Icons -->
			    <%= link_to image_tag("http://us.battle.net/static-render/us/" + thumbnail), "http://us.battle.net/wow/en/character/#{realm}/#{character_name}/advanced", :target => "_blank" %><br>
			    <!--Tauren-->
				<% if race == 6 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212064706/wowwiki/images/c/cb/Tauren_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 6 && gender == 0 %>
					<%= image_tag "http://images4.wikia.nocookie.net/__cb20071212064733/wowwiki/images/b/ba/Tauren_Male_32x32.png", height: '32', width: '32' %>
				<% end %> 

				<!--Undead-->
				<% if race == 5 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212063253/wowwiki/images/0/02/Forsaken_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 5 && gender == 0 %>
					<%= image_tag "http://images2.wikia.nocookie.net/__cb20071212063341/wowwiki/images/5/5f/Forsaken_Male_32x32.png", height: '32', width: '32' %>
				<% end %> 

				<!--Orc-->
				<% if race == 2 && gender == 1 %>
				    <%= image_tag "http://images1.wikia.nocookie.net/__cb20071212064612/wowwiki/images/3/35/Orc_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 2 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20071212064635/wowwiki/images/4/4c/Orc_Male_32x32.png", height: '32', width: '32' %>
				<% end %> 

				<!--Gnome-->
				<% if race == 7 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212063423/wowwiki/images/4/43/Gnome_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 7 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20071212063553/wowwiki/images/5/56/Gnome_Male_32x32.png", height: '32', width: '32' %>
				<% end %> 

				<!--Goblin-->
				<% if race == 9 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20111022221454/wowwiki/images/c/c1/Goblin_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 9 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20111022221550/wowwiki/images/5/58/Goblin_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Human-->
				<% if race == 1 && gender == 1 %>
				    <%= image_tag "http://images1.wikia.nocookie.net/__cb20071212064339/wowwiki/images/8/80/Human_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 1 && gender == 0 %>
					<%= image_tag "http://images3.wikia.nocookie.net/__cb20071212064436/wowwiki/images/5/56/Human_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Troll-->
				<% if race == 8 && gender == 1 %>
				    <%= image_tag "http://images1.wikia.nocookie.net/__cb20071212064761/wowwiki/images/7/78/Troll_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 8 && gender == 0 %>
					<%= image_tag "http://images3.wikia.nocookie.net/__cb20071212064850/wowwiki/images/c/ce/Troll_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Draenei-->
				<% if race == 11 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212062732/wowwiki/images/3/3c/Draenei_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 11 && gender == 0 %>
					<%= image_tag "http://images4.wikia.nocookie.net/__cb20071212062806/wowwiki/images/2/2e/Draenei_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Worgen-->
				<% if race == 22 && gender == 1 %>
				    <%= image_tag "http://a.deviantart.net/avatars/h/e/helasz.png?7", height: '32', width: '32' %>
				<% elsif race == 22 && gender == 0 %>
					<%= image_tag "http://fc07.deviantart.net/fs70/f/2010/326/d/6/worgen_male_icon_by_murlocaggrob_madmab-d33eq9f.jpg", height: '32', width: '32' %>
				<% end %>

				<!--Blood Elf-->
				<% if race == 10 && gender == 1 %>
				    <%= image_tag "http://images1.wikia.nocookie.net/__cb20071212062610/wowwiki/images/2/26/BloodElf_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 10 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20071212062644/wowwiki/images/3/30/BloodElf_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Night Elf-->
				<% if race == 4 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212064510/wowwiki/images/a/ab/NightElf_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 4 && gender == 0 %>
					<%= image_tag "http://images3.wikia.nocookie.net/__cb20071212064537/wowwiki/images/a/ad/NightElf_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Dwarf-->
				<% if race == 3 && gender == 1 %>
				    <%= image_tag "http://images2.wikia.nocookie.net/__cb20071212062905/wowwiki/images/e/e9/Dwarf_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 3 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20071212063003/wowwiki/images/f/f7/Dwarf_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Panda Ally-->
				<% if race == 25 && gender == 1 %>
				    <%= image_tag "http://images3.wikia.nocookie.net/__cb20120321050448/wowwiki/images/4/48/Pandaren_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 25 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20111022221708/wowwiki/images/a/a3/Pandaren_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<!--Panda Horde-->
				<% if race == 26 && gender == 1 %>
				    <%= image_tag "http://images3.wikia.nocookie.net/__cb20120321050448/wowwiki/images/4/48/Pandaren_Female_32x32.png", height: '32', width: '32' %>
				<% elsif race == 26 && gender == 0 %>
					<%= image_tag "http://images1.wikia.nocookie.net/__cb20111022221708/wowwiki/images/a/a3/Pandaren_Male_32x32.png", height: '32', width: '32' %>
				<% end %>

				<% if cls == 6 %>
			    <%= image_tag "http://hydra-media.cursecdn.com/wowpedia.org/e/e5/Ui-charactercreate-classes_deathknight.png", height: '32', width: '32' %>
				<% elsif cls == 11 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/6/6f/Ui-charactercreate-classes_druid.png", height: '32', width: '32' ) %>
				<% elsif cls == 3 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/4/4e/Ui-charactercreate-classes_hunter.png", height: '32', width: '32' ) %>
				<% elsif cls == 8 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/5/56/Ui-charactercreate-classes_mage.png", height: '32', width: '32' ) %>
				<% elsif cls == 10 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/2/24/Ui-charactercreate-classes_monk.png", height: '32', width: '32' ) %>
				<% elsif cls == 2 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/8/80/Ui-charactercreate-classes_paladin.png", height: '32', width: '32' ) %>
				<% elsif cls == 5 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/0/0f/Ui-charactercreate-classes_priest.png", height: '32', width: '32' ) %>
				<% elsif cls == 4 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/b/b1/Ui-charactercreate-classes_rogue.png", height: '32', width: '32' ) %>
				<% elsif cls == 7 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/3/3e/Ui-charactercreate-classes_shaman.png", height: '32', width: '32' ) %>
				<% elsif cls == 9 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/c/cf/Ui-charactercreate-classes_warlock.png", height: '32', width: '32' ) %>
				<% elsif cls == 1 %>
				    <%= image_tag("http://hydra-media.cursecdn.com/wowpedia.org/3/37/Ui-charactercreate-classes_warrior.png", height: '32', width: '32' ) %>
				 <% end %> 

				 <%= image_tag(spec, height: '32', width: '32' ) %>
			</td>

		    <td><!-- rbg Stats -->
		    	<strong><%= "#{cr} CR" %></strong><br>
		    	<%= "#{rbgw} Win - #{rbgl} Loss (#{winratio}%)" %>
		    </td>

		    <td><!--Arena stats -->
			    <strong><%= "2v2: #{arena2} CR " %></strong> <%= "(#{arena2w}-#{arena2l}), #{achv2} overall exp" %><br>
			    <strong><%= "3v3: #{arena3} CR " %></strong> <%= "(#{arena3w}-#{arena3l}), #{achv3} overall exp" %><br>
			    <strong><%= "5v5: #{arena5} CR " %></strong> <%= "(#{arena5w}-#{arena5l}), #{achv5} overall exp" %>
			</td>
			<td><!--gear -->

			<!-- gems-->
			<% if gems2["head"]>=2 && gems["shoulder"]>=1 && gems2["chest"]>=2 && gems["hands"]>=1 && gems2["legs"]>=2 && gems2["waist"]>=2 && gems["feet"]>=1 %>
				<span style="color:green">Fully Gemmed</span>
			<% else %>
				<span style="color:red">
					<% arr = [] %>
					<% count = 0 %>
					<% gems.each do |k, v| %>
						<% if v < 1 %>
							<% arr << k %>
							<% count += 1 %>
						<% end %>
					<% end %>
					<% gems2.each do |k, v| %>
						<% if v < 2 %>
							<% arr << k %>
							<% count += (2-v) %>
						<% end %>
					<% end %>	
				<%= "Missing #{count} PVP gems (#{arr.map(&:capitalize).join(', ')})" %>
				</span>
			<% end %>
			<br>

			<!-- enchants-->
			<% unless enchant.values.include?(0) %>
				<span style="color:green">Fully Enchanted</span>
			<% else %>
				<span style="color:red">
					<% arr = [] %>
					<% count = 0 %>
					<% enchant.each do |k, v| %>
						<% if v < 1 %>
							<% arr << k %>
							<% count += 1 %>
						<% end %>
					<% end %>

				<%= "Missing #{count} PVP enchants (#{arr.map(&:capitalize).join(', ')})" %>
				</span>
			<% end %>
			<br>


			</td>
	    </tr>
	    <% end %>
	<br>
  </tbody>
</table>


<hr>

<%= link_to 'Edit', edit_comp_path(@comp) %> |
<%= link_to 'Back', comps_path %>
